{
  "hash": "2f65a6c51fd80f79fbf99861d3947d9d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab 2: Spatial Analysis and Visualization\"\nsubtitle: \"Healthcare Access and Equity in Pennsylvania\"\nauthor: \"Angie Kwon\"\ndate: today\nformat: \n  html:\n    code-fold: false\n    toc: true\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\nexecute:\n  warning: false\n  message: false\n---\n\n## Assignment Overview\n\n**Learning Objectives:**\n- Apply spatial operations to answer policy-relevant research questions\n- Integrate census demographic data with spatial analysis\n- Create publication-quality visualizations and maps\n- Work with spatial data from multiple sources\n- Communicate findings effectively for policy audiences\n\n---\n\n## Part 1: Healthcare Access for Vulnerable Populations\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare investment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief explanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n- Pennsylvania county boundaries\n- Pennsylvania hospitals (from lecture data)\n- Pennsylvania census tracts\n\n**Your Task:**\n\n::: {.cell}\n\n:::\n\n\n**Questions to answer:**\n- How many hospitals are in your dataset? **223**\n- How many census tracts? **3445**\n- What coordinate reference system is each dataset in? **WGS 84 / pseudo mercator, WGS 84, NAD --> standardized to hospital dataset's CRS which is WGS 84.**\n\n---\n\n#### Step 2: Get Demographic Data \n\nUse `tidycensus` to download tract-level demographic data for Pennsylvania.\n\n**Required variables:**\n- Total population\n- Median household income\n- Population 65 years and over (you may need to sum multiple age categories)\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get demographic data from ACS\nacs_vars_2022 <- load_variables(2022, \"acs5\", cache = TRUE)\nacs_vars <- c(\n  total_pop = \"B01003_001\",\n  med_HH_income = \"B19013_001\",\n  m_6566 = \"B01001_020\",\n  m_6769 = \"B01001_021\",\n  m_7074 = \"B01001_022\", \n  m_7579 = \"B01001_023\", \n  m_8084 = \"B01001_024\", \n  m_85over = \"B01001_025\",\n  f_6566 = \"B01001_044\", \n  f_6769 = \"B01001_045\", \n  f_7074 = \"B01001_046\", \n  f_7579 = \"B01001_047\", \n  f_8084 = \"B01001_048\", \n  f_85over = \"B01001_049\"\n)\n\ndemo_data <- get_acs(geography = \"tract\",\n  variables = acs_vars,\n  state = \"PA\", survey = \"acs5\", year = 2022, output = \"wide\"\n  ) %>%\n  mutate(over_65E = m_6566E+m_6769E+m_7074E+m_7579E+m_8084E+m_85overE\n         +f_6566E+f_6769E+f_7074E+f_7579E+f_8084E+f_85overE) %>%\n  select(-c(m_6566E,m_6769E,m_7074E,m_7579E,m_8084E,m_85overE,\n         f_6566E,f_6769E,f_7074E,f_7579E,f_8084E,f_85overE,\n         m_6566M,m_6769M,m_7074M,m_7579M,m_8084M,m_85overM,\n         f_6566M,f_6769M,f_7074M,f_7579M,f_8084M,f_85overM))\n# %>%\n#   mutate(NAME = str_extract(NAME, \"Census Tract [0-9.]+\"))\n\n#wasn't joining because there was one census tract difference --> check what's in demo_data but not \n#census_tracts --> one census with total pop of 0 --> get rid of and then join again\ndiff <- setdiff(demo_data$GEOID, census_tracts$GEOID)\ndiff_row <- which(demo_data$GEOID == diff)\ndemo_data <- demo_data[-diff_row,]\n\n# Join to tract boundaries\n# tracts_demodata <- census_tracts %>%\n#   left_join(demo_data %>% select(total_popE, total_popM, med_HH_incomeE, med_HH_incomeM, over_65E), \n#             by = \"GEOID\")\ntracts_demodata <- census_tracts %>%\n  left_join(demo_data %>% select(-c(NAME)), \n            by = \"GEOID\")\n\n#how many tracts have missing income data\nmissing_income_count <- tracts_demodata %>%\n  count(is.na(med_HH_incomeE))\nmissing_income_tracts <- tracts_demodata %>% filter(is.na(med_HH_incomeE))\n\n#calculate mean of all median incomes\nall_med_inc <- mean(tracts_demodata$med_HH_incomeE, na.rm = TRUE)\n```\n:::\n\n\n**Questions to answer:**\n- What year of ACS data are you using? **2022**\n- How many tracts have missing income data? **62**\n- What is the median income across all PA census tracts? **$77527.23**\n\n---\n\n#### Step 3: Define Vulnerable Populations \n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n1. Low median household income (choose an appropriate threshold)\n2. Significant elderly population (choose an appropriate threshold)\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter for vulnerable tracts based on your criteria\n\n#taking out rows with missing median income data\nmissing_inc_rows <- which(is.na(tracts_demodata$med_HH_incomeE))\navail_inc_data <- tracts_demodata[-missing_inc_rows,]\n\n# 1. chose <60K as low median HH income\n# 2. adding column of percentage of elderly population --> chose 17% as sig\n# elderly pop threshold\navail_inc_data <- avail_inc_data %>%\n  mutate(elderly_per = over_65E/total_popE*100)\n\n#filter out vulnerable tracts\nvul_pop <- avail_inc_data %>% filter(med_HH_incomeE < 60000 & elderly_per >= 17)\n\n#percent of PA CT that are vulnerable\nPA_per_vul <- nrow(vul_pop)/nrow(census_tracts)*100\n```\n:::\n\n\n**Questions to answer:**\n- What income threshold did you choose and why? **$60,000 because ____**\n- What elderly population threshold did you choose and why? **17% because the national proportion for population over 65 is around 16.85%**\n- How many tracts meet your vulnerability criteria? **574**\n- What percentage of PA census tracts are considered vulnerable by your definition? **16.67%*\n\n---\n\n#### Step 4: Calculate Distance to Hospitals \n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Transform to appropriate projected CRS\nst_crs(vul_pop)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: WGS 84 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    ID[\"EPSG\",4326]]\n```\n\n\n:::\n\n```{.r .cell-code}\n# in WGS 84\n\n# Calculate distance from each tract centroid to nearest hospital\nvul_tract_centroid <- st_centroid(vul_pop)\n\nnearest_index <- st_nearest_feature(vul_tract_centroid, hospitals)\n\nnearest_dist <- st_distance(vul_tract_centroid, hospitals[nearest_index,],\n                            by_element = TRUE)\n\nvul_pop$nearest_hosp <- as.numeric(nearest_dist/1609.344) #make it in km's\n\n# avg distance to hospitals for all vulnerable tracts\navg_hosp_dist <- mean(vul_pop$nearest_hosp, na.rm = TRUE)\n\n# maximum distance\nmax_dist <- vul_pop %>% slice_max(nearest_hosp, n=1)\n\n# >15 miles\nmore_15 <- vul_pop %>% filter(nearest_hosp > 15)\nnrow(more_15)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 34\n```\n\n\n:::\n:::\n\n\n**Requirements:**\n- Use an appropriate projected coordinate system for Pennsylvania\n- Calculate distances in miles\n- Explain why you chose your projection\n\n**Questions to answer:**\n- What is the average distance to the nearest hospital for vulnerable tracts?\n- What is the maximum distance?\n- How many vulnerable tracts are more than 15 miles from the nearest hospital?\n\n---\n\n#### Step 5: Identify Underserved Areas \n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create underserved variable\nunderserved <- more_15\n\n#how many\nnrow(more_15)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 34\n```\n\n\n:::\n\n```{.r .cell-code}\n#per_underserved\nper_und <- nrow(underserved)/nrow(vul_pop)*100\n```\n:::\n\n\n**Questions to answer:**\n- How many tracts are underserved?\n- What percentage of vulnerable tracts are underserved?\n- Does this surprise you? Why or why not?\n\n---\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n#add underserved status to vul_pop\nvul_pop <- vul_pop %>% \n  mutate(underserved = case_when(nearest_hosp > 15 ~ 'Underserved',\n                                   TRUE ~ 'Appropriately Served'))\n\n#hospital buffer of 15 miles\nhospital_service_areas <- hospitals %>%\n  st_buffer(dist = 24140)\nhospital_service_areas <- st_transform(hospital_service_areas, st_crs(hospitals))\ncombined_service_area <- hospital_service_areas %>%\n  st_union() %>%\n  st_make_valid()\n\n#outside hospital service area\noutside_hosp <- st_difference(pa_counties, combined_service_area)\n\n# ggplot() +\n#   geom_sf(data = pa_counties, fill = \"grey\", color = \"gray\") +\n#   geom_sf(data = outside_hosp, fill = \"lightblue\", alpha = 0.4) +\n#   geom_sf(data = hospitals, color = \"red\", size = 2) +\n#   labs(\n#     title = paste(\"outside hospital service area\"),\n#     subtitle = \"Red points = Hospitals, Blue areas = 15-mile service zones\"\n#   ) +\n#   theme_void()\n\n#ppl over 65 living outside hospital service area\nover65_summary <- vul_pop %>%\n  st_join(outside_hosp %>% select(COUNTY_NAM)) %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarize(\n    total_vul_pop = sum(total_popE, na.rm = TRUE),\n    .groups = \"drop\"\n  )\nover65_outside_hosp <- pa_counties %>%\n  select(COUNTY_NAM) %>%\n  st_drop_geometry() %>%\n  left_join(over65_summary, by = \"COUNTY_NAM\") %>%\n  mutate(\n    total_vul_pop = coalesce(total_vul_pop, 0)\n  )\n\n# Spatial join tracts to counties\ntracts_by_county <- vul_pop %>%\n  st_join(pa_counties %>% select(COUNTY_NAM)) %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarize(\n    tot_pop = sum(total_popE),\n    n_tracts = n_distinct(GEOID),\n    tract_ids = paste(unique(NAMELSAD), collapse = \", \"),\n    n_underserved = sum(underserved == \"Underserved\"),\n    avg_hosp_dist = mean(nearest_hosp),\n  ) %>%\n  arrange(desc(n_tracts))\n\n# Aggregate statistics by county\n\n# percent of vul tracts that are underserved\ntracts_by_county <- tracts_by_county %>%\n  mutate(per_underserved = n_underserved/n_tracts*100)\n\n# top 5 counties w highest percentage of underserved vul tracts\nhighest_per_und_vul <- tracts_by_county %>% slice_max(per_underserved, n=5)\n\n# counties w the most vul ppl living far from hospitals\ntracts_by_county <- tracts_by_county %>% left_join(over65_outside_hosp, by = \"COUNTY_NAM\")\nmost_vul <- tracts_by_county %>% arrange(desc(total_vul_pop))\n```\n:::\n\n\n**Required county-level statistics:**\n- Number of vulnerable tracts\n- Number of underserved tracts  \n- Percentage of vulnerable tracts that are underserved\n- Average distance to nearest hospital for vulnerable tracts\n- Total vulnerable population\n\n**Questions to answer:**\n- Which 5 counties have the highest percentage of underserved vulnerable tracts?\n- Which counties have the most vulnerable people living far from hospitals?\n- Are there any patterns in where underserved counties are located?\n\n---\n\n#### Step 7: Create Summary Table \n\nCreate a professional table showing the top 10 priority counties for healthcare investment.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create and format priority counties table\n```\n:::\n\n\n**Requirements:**\n- Use `knitr::kable()` or similar for formatting\n- Include descriptive column names\n- Format numbers appropriately (commas for population, percentages, etc.)\n- Add an informative caption\n- Sort by priority (you decide the metric)\n\n---\n\n## Part 2: Comprehensive Visualization \n\nUsing the skills from Week 3 (Data Visualization), create publication-quality maps and charts.\n\n### Map 1: County-Level Choropleth \n\nCreate a choropleth map showing healthcare access challenges at the county level.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create county-level access map\n```\n:::\n\n\n**Requirements:**\n- Fill counties by percentage of vulnerable tracts that are underserved\n- Include hospital locations as points\n- Use an appropriate color scheme\n- Include clear title, subtitle, and caption\n- Use `theme_void()` or similar clean theme\n- Add a legend with formatted labels\n\n---\n\n### Map 2: Detailed Vulnerability Map \n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create detailed tract-level map\n```\n:::\n\n\n**Requirements:**\n- Show underserved vulnerable tracts in a contrasting color\n- Include county boundaries for context\n- Show hospital locations\n- Use appropriate visual hierarchy (what should stand out?)\n- Include informative title and subtitle\n\n---\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for vulnerable populations.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create distribution visualization\n```\n:::\n\n\n**Suggested chart types:**\n- Histogram or density plot of distances\n- Box plot comparing distances across regions\n- Bar chart of underserved tracts by county\n- Scatter plot of distance vs. vulnerable population size\n\n**Requirements:**\n- Clear axes labels with units\n- Appropriate title\n- Professional formatting\n- Brief interpretation (1-2 sentences as a caption or in text)\n\n---\n\n## Part 3: Bring Your Own Data Analysis \n\nChoose your own additional spatial dataset and conduct a supplementary analysis.\n\n### Your Analysis\n\n**Your Task:**\n\n1. **Find and load additional data**\n   - Document your data source\n   - Check and standardize the CRS\n   - Provide basic summary statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load your additional dataset\nod_deaths <- st_read(here(\"labs/lab_2/data/Estimated Drug Overdose Deaths CY 2012-Current County Health_20260223.shp\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Estimated Drug Overdose Deaths CY 2012-Current County Health_20260223' from data source `/Users/angiekwon/Documents/GitHub/akwon_portfolio/labs/lab_2/data/Estimated Drug Overdose Deaths CY 2012-Current County Health_20260223.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 884 features and 11 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -80.35107 ymin: 39.34613 xmax: -75.03271 ymax: 41.99414\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\nems_stations <- st_read(here(\"labs/lab_2/data/Fire_and_Emergency_Medical_Service__EMS__Stations_pt.shp\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Fire_and_Emergency_Medical_Service__EMS__Stations_pt' from data source `/Users/angiekwon/Documents/GitHub/akwon_portfolio/labs/lab_2/data/Fire_and_Emergency_Medical_Service__EMS__Stations_pt.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 2591 features and 23 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -8962629 ymin: 4825800 xmax: -8315350 ymax: 5193523\nProjected CRS: WGS 84 / Pseudo-Mercator\n```\n\n\n:::\n\n```{.r .cell-code}\nod_deaths <- st_transform(od_deaths, st_crs(hospitals))\nems_stations <- st_transform(ems_stations, st_crs(hospitals))\n```\n:::\n\n\n**Questions to answer:**\n- What dataset did you choose and why?\n- What is the data source and date?\n- How many features does it contain?\n- What CRS is it in? Did you need to transform it?\n\n---\n\n2. **Pose a research question**\n\nWrite a clear research statement that your analysis will answer.\n\n**Examples:**\n- \"Do vulnerable tracts have adequate public transit access to hospitals?\"\n- \"Are EMS stations appropriately located near vulnerable populations?\"\n- \"Do areas with low vehicle access have worse hospital access?\"\n\nAre there more opioid overdoses in vulnerable areas?\n\n---\n\n3. **Conduct spatial analysis**\n\nUse at least TWO spatial operations to answer your research question.\n\n**Required operations (choose 2+):**\n- Buffers\n- Spatial joins\n- Spatial filtering with predicates\n- Distance calculations\n- Intersections or unions\n- Point-in-polygon aggregation\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Your spatial analysis\nod_deaths$county <- toupper(od_deaths$county)\n\n#summarize od deaths by county\nod_by_county <- od_deaths %>%\n  filter(year == 2024) %>%\n  st_join(pa_counties %>% select(COUNTY_NAM)) %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarize(\n    n_od_2024 = sum(count, na.rm = TRUE)\n  )\n\n#join od deaths to counties\ntracts_by_county <- tracts_by_county %>% left_join(od_by_county, by = \"COUNTY_NAM\")\n\n#percentage of vulnerable ppl of total pop & od deaths:vulnerable ppl ratio\ntracts_by_county <- tracts_by_county %>%\n  mutate(per_vul = total_vul_pop/tot_pop*100,\n         od_vul_ratio = n_od_2024/total_vul_pop*100)\ntracts_by_county$od_vul_ratio[is.infinite(tracts_by_county$od_vul_ratio)] <- 0\ntracts_by_county$od_vul_ratio[is.nan(tracts_by_county$od_vul_ratio)] <- 0\n```\n:::\n\n\n**Analysis requirements:**\n- Clear code comments explaining each step\n- Appropriate CRS transformations\n- Summary statistics or counts\n- At least one map showing your findings\n- Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\n\n[Write your findings here]\n\n\n## Finally - A few comments about your incorporation of feedback!\nTake a few moments to clean up your markdown document and then write a line or two or three about how you may have incorporated feedback that you received after your first assignment. \n\n---\n\n## Submission Requirements\n\n**What to submit:**\n\n1. **Rendered HTML document posted to your course portfolio** with all code, outputs, maps, and text\n   - Use `embed-resources: true` in YAML so it's a single file\n   - All code should run without errors\n   - All maps and charts should display correctly\n2. Submit the correct and working links of your assignment on Canvas\n\n---\n\n",
    "supporting": [
      "lab2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}