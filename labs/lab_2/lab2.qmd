---
title: "Lab 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Angie Kwon"
date: today
format: 
  html:
    code-fold: false
    toc: true
    toc-location: left
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Assignment Overview

**Learning Objectives:**
- Apply spatial operations to answer policy-relevant research questions
- Integrate census demographic data with spatial analysis
- Create publication-quality visualizations and maps
- Work with spatial data from multiple sources
- Communicate findings effectively for policy audiences

---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**

Your analysis should identify counties that should be priorities for healthcare investment and policy intervention.

### Required Analysis Steps

Complete the following analysis, documenting each step with code and brief explanations:

#### Step 1: Data Collection (5 points)

Load the required spatial data:
- Pennsylvania county boundaries
- Pennsylvania hospitals (from lecture data)
- Pennsylvania census tracts

**Your Task:**
```{r, results='hide'}
#| echo: false

# Load required packages
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)
library(xts)
library(kableExtra)

# Load spatial data
pa_counties <- st_read(here("labs/lab_2/data/Pennsylvania_County_Boundaries.shp"))
hospitals <- st_read(here("labs/lab_2/data/hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE)

# Check that all data loaded correctly

# check crs
st_crs(pa_counties)
st_crs(hospitals)
st_crs(census_tracts)

# standardize crs
pa_counties <- st_transform(pa_counties, st_crs(hospitals))
census_tracts <- st_transform(census_tracts, st_crs(hospitals))
```

**Questions to answer:**
- How many hospitals are in your dataset? **223**
- How many census tracts? **3445**
- What coordinate reference system is each dataset in? **WGS 84 / pseudo mercator, WGS 84, NAD --> standardized to hospital dataset's CRS which is WGS 84.**

---

#### Step 2: Get Demographic Data 

Use `tidycensus` to download tract-level demographic data for Pennsylvania.

**Required variables:**
- Total population
- Median household income
- Population 65 years and over (you may need to sum multiple age categories)

**Your Task:**
```{r, results='hide'}
# Get demographic data from ACS
acs_vars_2022 <- load_variables(2022, "acs5", cache = TRUE)
acs_vars <- c(
  total_pop = "B01003_001",
  med_HH_income = "B19013_001",
  m_6566 = "B01001_020",
  m_6769 = "B01001_021",
  m_7074 = "B01001_022", 
  m_7579 = "B01001_023", 
  m_8084 = "B01001_024", 
  m_85over = "B01001_025",
  f_6566 = "B01001_044", 
  f_6769 = "B01001_045", 
  f_7074 = "B01001_046", 
  f_7579 = "B01001_047", 
  f_8084 = "B01001_048", 
  f_85over = "B01001_049"
)

demo_data <- get_acs(geography = "tract",
  variables = acs_vars,
  state = "PA", survey = "acs5", year = 2022, output = "wide"
  ) %>%
  mutate(over_65E = m_6566E+m_6769E+m_7074E+m_7579E+m_8084E+m_85overE
         +f_6566E+f_6769E+f_7074E+f_7579E+f_8084E+f_85overE) %>%
  select(-c(m_6566E,m_6769E,m_7074E,m_7579E,m_8084E,m_85overE,
         f_6566E,f_6769E,f_7074E,f_7579E,f_8084E,f_85overE,
         m_6566M,m_6769M,m_7074M,m_7579M,m_8084M,m_85overM,
         f_6566M,f_6769M,f_7074M,f_7579M,f_8084M,f_85overM))
# %>%
#   mutate(NAME = str_extract(NAME, "Census Tract [0-9.]+"))

#wasn't joining because there was one census tract difference --> check what's in demo_data but not 
#census_tracts --> one census with total pop of 0 --> get rid of and then join again
diff <- setdiff(demo_data$GEOID, census_tracts$GEOID)
diff_row <- which(demo_data$GEOID == diff)
demo_data <- demo_data[-diff_row,]

# Join to tract boundaries
# tracts_demodata <- census_tracts %>%
#   left_join(demo_data %>% select(total_popE, total_popM, med_HH_incomeE, med_HH_incomeM, over_65E), 
#             by = "GEOID")
tracts_demodata <- census_tracts %>%
  left_join(demo_data %>% select(-c(NAME)), 
            by = "GEOID")

#how many tracts have missing income data
missing_income_count <- tracts_demodata %>%
  count(is.na(med_HH_incomeE))
missing_income_tracts <- tracts_demodata %>% filter(is.na(med_HH_incomeE))

#calculate mean of all median incomes
all_med_inc <- mean(tracts_demodata$med_HH_incomeE, na.rm = TRUE)
```

**Questions to answer:**
- What year of ACS data are you using? **2022**
- How many tracts have missing income data? **62**
- What is the median income across all PA census tracts? **$77527.23**

---

#### Step 3: Define Vulnerable Populations 

Identify census tracts with vulnerable populations based on TWO criteria:
1. Low median household income (choose an appropriate threshold)
2. Significant elderly population (choose an appropriate threshold)

**Your Task:**
```{r, results='hide'}
# Filter for vulnerable tracts based on your criteria

#taking out rows with missing median income data
missing_inc_rows <- which(is.na(tracts_demodata$med_HH_incomeE))
avail_inc_data <- tracts_demodata[-missing_inc_rows,]

# 1. chose <60K as low median HH income
# 2. adding column of percentage of elderly population --> chose 17% as sig
# elderly pop threshold
avail_inc_data <- avail_inc_data %>%
  mutate(elderly_per = over_65E/total_popE*100)

#filter out vulnerable tracts
vul_pop <- avail_inc_data %>% filter(med_HH_incomeE < 60000 & elderly_per >= 17)

#percent of PA CT that are vulnerable
PA_per_vul <- nrow(vul_pop)/nrow(census_tracts)*100
```

**Questions to answer:**
- What income threshold did you choose and why? **$60,000 because ____**
- What elderly population threshold did you choose and why? **17% because the national proportion for population over 65 is around 16.85%**
- How many tracts meet your vulnerability criteria? **574**
- What percentage of PA census tracts are considered vulnerable by your definition? **16.67%*

---

#### Step 4: Calculate Distance to Hospitals 

For each vulnerable tract, calculate the distance to the nearest hospital.

**Your Task:**
```{r, results='hide'}
# Transform to appropriate projected CRS
st_crs(vul_pop)
# in WGS 84

# Calculate distance from each tract centroid to nearest hospital
vul_tract_centroid <- st_centroid(vul_pop)

nearest_index <- st_nearest_feature(vul_tract_centroid, hospitals)

nearest_dist <- st_distance(vul_tract_centroid, hospitals[nearest_index,],
                            by_element = TRUE)

vul_pop$nearest_hosp <- as.numeric(nearest_dist/1609.344) #make it in km's

# avg distance to hospitals for all vulnerable tracts
avg_hosp_dist <- mean(vul_pop$nearest_hosp, na.rm = TRUE)

# maximum distance
max_dist <- vul_pop %>% slice_max(nearest_hosp, n=1)

# >15 miles
more_15 <- vul_pop %>% filter(nearest_hosp > 15)
nrow(more_15)
```

**Requirements:**
- Use an appropriate projected coordinate system for Pennsylvania
- Calculate distances in miles
- Explain why you chose your projection

**Questions to answer:**
- What is the average distance to the nearest hospital for vulnerable tracts? **4.94 miles**
- What is the maximum distance? **29.06 miles**
- How many vulnerable tracts are more than 15 miles from the nearest hospital? **34 tracts**

---

#### Step 5: Identify Underserved Areas 

Define "underserved" as vulnerable tracts that are more than 15 miles from the nearest hospital.

**Your Task:**
```{r, results='hide'}
# Create underserved variable
underserved <- more_15

#how many
nrow(more_15)

#per_underserved
per_und <- nrow(underserved)/nrow(vul_pop)*100
```

**Questions to answer:**
- How many tracts are underserved? **34 tracts**
- What percentage of vulnerable tracts are underserved? **5.92% of vulnerable tracts are underserved**
- Does this surprise you? Why or why not? **This surprises me a little bit, as it was quite low and I assumed tracts with vulnerable populations would be generally underserved in most aspects, as one of the criteria was low income. However, I see that this may happen because despite the low income, counties and local governments might have prepared ahead for the vulnerable populations, knowing they would need the hospitals more.**

---

#### Step 6: Aggregate to County Level

Use spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.

**Your Task:**
```{r, results='hide'}
#add underserved status to vul_pop
vul_pop <- vul_pop %>% 
  mutate(underserved = case_when(nearest_hosp > 15 ~ 'Underserved',
                                   TRUE ~ 'Appropriately Served'))
vul_pop <- st_transform(vul_pop, st_crs(hospitals))
#hospital buffer of 15 miles
hospital_service_areas <- hospitals %>%
  st_buffer(dist = 24140)
hospital_service_areas <- st_transform(hospital_service_areas, st_crs(hospitals))
combined_service_area <- hospital_service_areas %>%
  st_union() %>%
  st_make_valid()

#outside hospital service area
outside_hosp <- st_difference(pa_counties, combined_service_area)

# ggplot() +
#   geom_sf(data = pa_counties, fill = "grey", color = "gray") +
#   geom_sf(data = outside_hosp, fill = "lightblue", alpha = 0.4) +
#   geom_sf(data = hospitals, color = "red", size = 2) +
#   labs(
#     title = paste("outside hospital service area"),
#     subtitle = "Red points = Hospitals, Blue areas = 15-mile service zones"
#   ) +
#   theme_void()

#ppl living outside hospital service area
pop_summary <- vul_pop %>%
  st_join(outside_hosp %>% select(COUNTY_NAM)) %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    pop_outHosp = sum(total_popE, na.rm = TRUE),
    .groups = "drop"
  )
pop_outside_hosp <- pa_counties %>%
  select(COUNTY_NAM) %>%
  st_drop_geometry() %>%
  left_join(pop_summary, by = "COUNTY_NAM") %>%
  mutate(
    pop_outHosp = coalesce(pop_outHosp, 0)
  )

# #ppl over 65 living outside hospital service area
over65_summary <- vul_pop %>%
  st_join(outside_hosp %>% select(COUNTY_NAM)) %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    total_vul_pop = sum(over_65E, na.rm = TRUE),
    .groups = "drop"
  )
over65_outside_hosp <- pa_counties %>%
  select(COUNTY_NAM) %>%
  st_drop_geometry() %>%
  left_join(over65_summary, by = "COUNTY_NAM") %>%
  mutate(
    total_vul_pop = coalesce(total_vul_pop, 0)
  )

# Spatial join tracts to counties
tracts_by_county <- vul_pop %>%
  st_join(pa_counties %>% select(COUNTY_NAM)) %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    tot_pop = sum(total_popE),
    n_tracts = n_distinct(GEOID),
    tract_ids = paste(unique(NAMELSAD), collapse = ", "),
    n_underserved = sum(underserved == "Underserved"),
    avg_hosp_dist = mean(nearest_hosp),
  ) %>%
  arrange(desc(n_tracts))

# Aggregate statistics by county

# percent of vul tracts that are underserved
#total
34/574*100
#per county
tracts_by_county <- tracts_by_county %>%
  mutate(per_underserved = n_underserved/n_tracts*100)

# total vul pop in PA
sum(vul_pop$total_popE)

# top 5 counties w highest percentage of underserved vul tracts
highest_per_und_vul <- tracts_by_county %>% slice_max(per_underserved, n=5)
highest_per_und_vul_10 <- tracts_by_county %>% slice_max(per_underserved, n=10)

# counties w the most vul ppl living far from hospitals
tracts_by_county <- tracts_by_county %>% left_join(pop_outside_hosp, by = "COUNTY_NAM")
# tracts_by_county <- tracts_by_county %>% left_join(over65_outside_hosp, by = "COUNTY_NAM")
most_vul <- tracts_by_county %>% arrange(desc(pop_outHosp))
```

**Required county-level statistics:**
- Number of vulnerable tracts **574 vulnerable tracts**
- Number of underserved tracts  **34 underserved tracts**
- Percentage of vulnerable tracts that are underserved  **5.92% are underserved**
- Average distance to nearest hospital for vulnerable tracts  **4.94 miles**
- Total vulnerable population in PA **1802220**

**Questions to answer:**
- Which 5 counties have the highest percentage of underserved vulnerable tracts?
- Which counties have the most vulnerable people living far from hospitals?
- Are there any patterns in where underserved counties are located? **For high proportion of underserved tracts, it makes sense that most of the counties are smaller ones, with small total number of tracts. For counties with the most vulnerable people living far from hospitals, it makes sense that it would be slightly bigger counties, where people are more spread apart.**

```{r}
kable(highest_per_und_vul[, c(1,3,5,7)], "simple", 
      col.names = c("County Name", "# of Tracts", "# of Underserved Tracts", 
                    "% of Underserved Tracts"), 
      caption = "Which 5 counties have the highest percentage of underserved vulnerable tracts?")

kable(most_vul[, c(1,8,2, 3,5,7,6)], "simple", 
      col.names = c("County Name", "Population >15 miles of Hospitals", "Total Population", 
                    "# of Tracts", "# of Underserved Tracts", "% of Underserved Tracts",
                    "Average Distance to Hospitals"), 
      caption = "Which counties have the most vulnerable people living far from hospitals?")
```
---

#### Step 7: Create Summary Table 

Create a professional table showing the top 10 priority counties for healthcare investment.

**Your Task:**
```{r}
# Create and format priority counties table
kable(highest_per_und_vul_10[, c(1,2,3,5,7,6)], "simple", 
      col.names = c("County Name","Total Population", "# of Tracts", "# of Underserved Tracts", 
                    "% of Underserved Tracts", "Average Distance to Hospitals"), 
      caption = "Top 10 priority counties for healthcare investment")

```
---

## Part 2: Comprehensive Visualization 

Using the skills from Week 3 (Data Visualization), create publication-quality maps and charts.

### Map 1: County-Level Choropleth 

Create a choropleth map showing healthcare access challenges at the county level.

**Your Task:**
```{r, results='hide'}
#| echo: false

# Spatial join tracts to counties
tracts_by_county <- vul_pop %>%
  st_join(pa_counties %>% select(COUNTY_NAM)) %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    tot_pop = sum(total_popE),
    n_tracts = n_distinct(GEOID),
    tract_ids = paste(unique(NAMELSAD), collapse = ", "),
    n_underserved = sum(underserved == "Underserved"),
    avg_hosp_dist = mean(nearest_hosp),
  ) %>%
  arrange(desc(n_tracts))
tracts_by_county <- tracts_by_county %>%
  mutate(per_underserved = n_underserved/n_tracts*100)
# total vul pop in PA
sum(vul_pop$total_popE)

# top 5 counties w highest percentage of underserved vul tracts
highest_per_und_vul <- tracts_by_county %>% slice_max(per_underserved, n=5)
highest_per_und_vul_10 <- tracts_by_county %>% slice_max(per_underserved, n=10)

# counties w the most vul ppl living far from hospitals
tracts_by_county <- tracts_by_county %>% left_join(pop_outside_hosp, by = "COUNTY_NAM")
# tracts_by_county <- tracts_by_county %>% left_join(over65_outside_hosp, by = "COUNTY_NAM")
most_vul <- tracts_by_county %>% arrange(desc(pop_outHosp))
```

```{r}
#| echo: false
# Create county-level access map
ggplot(tracts_by_county) +
  geom_sf(data = pa_counties, fill = "lightgrey", color = "lightgray") +
  geom_sf(aes(fill = per_underserved), color = "white", size = 0.5) +
  geom_sf(data = hospitals, color = "red", size = 0.5) +
  scale_fill_viridis_c(
    name = "% of Underserved\nTracts",
    option = "plasma"
  ) +
  labs(
    title = "% of vulnerable tracts that are underserved",
    subtitle = "Pennsylvania",
    caption = "Source: ACS 2022"
  ) +
  theme_void()
```
---

### Map 2: Detailed Vulnerability Map 

Create a map highlighting underserved vulnerable tracts.

**Your Task:**
```{r}
#| echo: false
# Create detailed tract-level map
ggplot(underserved) +
  geom_sf(data = pa_counties, fill = "lightgrey", color = "lightgray") +
  geom_sf(aes(fill = nearest_hosp), color = "white", size = 0.5) +
  geom_sf(data = hospital_service_areas, fill = "lightblue", color = "lightblue", alpha = 0.2) +
  geom_sf(data = hospitals, color = "red", size = 0.5) +
  scale_fill_viridis_c(
    name = "Distance to \nClosest Hospital (Mile)",
    option = "plasma"
  ) +
  labs(
    title = "Underserved vulnerables and distance to nearest hospital",
    subtitle = "Pennsylvania",
    caption = "Source: ACS 2022"
  ) +
  theme_void()
```
---

### Chart: Distribution Analysis

Create a visualization showing the distribution of distances to hospitals for vulnerable populations.

**Your Task:**
```{r}
#| echo: false
# Create distribution visualization
ggplot(vul_pop) +
  aes(x = nearest_hosp) +
  geom_histogram(bins = 15, fill = "steelblue", color = "white", alpha = 0.9) +
  labs(
    title = "Distribution of Distances to Nearest Hospital",
    x = "Distance to Nearest Hospital (Mile)",
    y = "Number of Tracts",
    caption = "Source: ACS 2022 \nSkews towards the left, showing that most tracts are less than 10  miles from the nearest hospital."
  ) +
  theme_minimal()
```
---

## Part 3: Bring Your Own Data Analysis 

Choose your own additional spatial dataset and conduct a supplementary analysis.

### Your Analysis

**Your Task:**

1. **Find and load additional data**
```{r, results='hide'}
# Load your additional dataset
od_deaths <- st_read(here("labs/lab_2/data/Estimated Drug Overdose Deaths CY 2012-Current County Health_20260223.shp"))
ems_stations <- st_read(here("labs/lab_2/data/Fire_and_Emergency_Medical_Service__EMS__Stations_pt.shp"))

od_deaths <- st_transform(od_deaths, st_crs(hospitals))
ems_stations <- st_transform(ems_stations, st_crs(hospitals))
```

**Questions to answer:**
- What dataset did you choose and why? **Estimated Drug Overdose Deaths, because I wanted to examine whether there is a correlative relationship between vulnerable populations and the opioids crisis.**
- What is the data source and date? **PA Open Data, and the data's year ranges from 2012-2024.**
- How many features does it contain? **884 data points**
- What CRS is it in? Did you need to transform it? **WGS 84, transformed just in case**

---

2. **Pose a research question**

**Are there more opioid overdoses in vulnerable areas?**

---

3. **Conduct spatial analysis**
```{r, results='hide'}
# Your spatial analysis

# ems station buffer
ems_buffer <- ems_stations %>%
  st_buffer(dist = 10000)
ems_buffer <- st_transform(ems_buffer, st_crs(hospitals))
combined_ems_buffer <- ems_buffer %>%
  st_union() %>%
  st_make_valid()

# capitalize county names
od_deaths$county <- toupper(od_deaths$county)

#summarize od deaths by county
od_by_county <- od_deaths %>%
  filter(year == 2024) %>%
  st_join(pa_counties %>% select(COUNTY_NAM)) %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    n_od_2024 = sum(count, na.rm = TRUE)
  )

#join od deaths to counties
tracts_by_county <- tracts_by_county %>% left_join(od_by_county, by = "COUNTY_NAM")

#percentage of vulnerable ppl of total pop & od deaths:vulnerable ppl ratio
tracts_by_county <- tracts_by_county %>%
  mutate(od_vul_ratio = n_od_2024/tot_pop*100)
tracts_by_county$od_vul_ratio[is.infinite(tracts_by_county$od_vul_ratio)] <- 0
tracts_by_county$od_vul_ratio[is.nan(tracts_by_county$od_vul_ratio)] <- 0
```

```{r}
#| echo: false
# Table
top_od_vul <- slice_max(tracts_by_county, tracts_by_county$od_vul_ratio, n=10)
kable(top_od_vul[, c(1,2,10,11,8, 7)], "simple", 
      col.names = c("County Name","Total Vulnerable Population", "# of OD in 2024", 
                    "# of OD to Vulnerable Population Ratio", "% Underserved Tracts", "Geometry"), 
      caption = "Top 10 priority counties for healthcare investment")

# Create detailed tract-level map
ggplot(tracts_by_county) +
  geom_sf(data = pa_counties, fill = "lightgrey", color = "lightgray") +
  geom_sf(aes(fill = od_vul_ratio), color = "white") +
  geom_sf(data = combined_ems_buffer, fill = "lightblue", color = "lightblue", alpha = 0.2) +
  # geom_sf(data = hospitals, color = "red", size = 0.5) +
  geom_sf(data = ems_stations, color = "red", size = 0.01) +
  scale_fill_viridis_c(
    name = "RATIO: # OD's in 2024 to Total \nVulnerable Population",
    option = "plasma"
  ) +
  labs(
    title = "Ratio of OD's to vulnerable population & EMS service zones",
    subtitle = "Pennsylvania",
    caption = "Source: ACS 2022"
  ) +
  theme_void()
```

**Your interpretation:**

It seems that there isn't that clear of a relationship. Further analysis seems to be needed. Many of the top 10 counties with high OD deaths to total population seems to have 0 underserved tracts in the whole county. But maybe this could be exptected given that counties with a bigger opioid crisis might keep the county better prepped. There doesn't seem to be a large correlation with population either. The map seems to show that the majority of OD's seem to be concentrated in counties with large populations, such as Philadelphia. This is also to be expected. Maybe further analyses without the outliers may help.

