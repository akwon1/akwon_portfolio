gc()
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)
# Load the data (same as lecture)
pa_counties <- st_read(here("data/Pennsylvania_County_Boundaries.shp"))
districts <- st_read(here("data/districts.geojson"))
hospitals <- st_read(here("data/hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE)
metro_areas <- core_based_statistical_areas(cb = TRUE)
# Standardize CRS
hospitals <- st_transform(hospitals, st_crs(pa_counties))
census_tracts <- st_transform(census_tracts, st_crs(pa_counties))
metro_areas <- st_transform(metro_areas, st_crs(pa_counties))
View(pa_counties)
# Step 1: Look at available county names
unique(pa_counties$COUNTY_NAM)
# Step 2: Pick one county (change this to your choice!)
my_county <- pa_counties %>%
filter(COUNTY_NAM == "DELAWARE")  # Change "CENTRE" to your county
# Step 3: Find neighbors using st_touches
my_neighbors <- pa_counties %>%
st_filter(my_county, .predicate = st_touches)
# Step 4: How many neighbors does your county have?
cat("Number of neighboring counties:", nrow(my_neighbors), "\n")
# Step 4: How many neighbors does your county have?
cat("Number of neighboring counties:", nrow(my_neighbors), "\n")
print("Neighbor names:")
print(my_neighbors$COUNTY_NAM)
print("Neighbor names:")
print(my_neighbors$COUNTY_NAM)
# Create the map
ggplot() +
geom_sf(data = pa_counties, fill = "lightgray", color = "white") +
geom_sf(data = my_neighbors, fill = "lightblue", alpha = 0.7) +
geom_sf(data = my_county, fill = "darkblue") +
labs(
title = paste("Neighbors of", my_county$COUNTY_NAM[1], "County"),
subtitle = paste(nrow(my_neighbors), "neighboring counties")
) +
theme_void()
# Use st_intersects
intersecting_counties <- pa_counties %>%
st_filter(my_county, .predicate = st_intersects)
cat("With st_touches:", nrow(my_neighbors), "counties\n")
cat("With st_intersects:", nrow(intersecting_counties), "counties\n")
cat("Difference:", nrow(intersecting_counties) - nrow(my_neighbors), "\n")
intersecting_counties
# Step 1: Filter hospitals in your county
# First do a spatial join to assign counties to hospitals
hospitals_with_county <- hospitals %>%
st_join(pa_counties %>% select(COUNTY_NAM))
hospitals_with_county
# Filter for your county's hospitals
my_county_hospitals <- hospitals_with_county %>%
filter(COUNTY_NAM == "DELAWARE")  # Change to match your county
cat("Number of hospitals in county:", nrow(my_county_hospitals), "\n")
# Step 2: Project to accurate CRS for buffering
my_county_hospitals_proj <- my_county_hospitals %>%
st_transform(3365)  # Pennsylvania State Plane South
hospital_service_areas
# Step 4: Transform back for mapping
hospital_service_areas <- st_transform(hospital_service_areas, st_crs(pa_counties))
# Step 3: Create 15-mile buffers (24140 meters = 15 miles)
hospital_service_areas <- my_county_hospitals_proj %>%
st_buffer(dist = 79200)  # 15 miles in feet for PA State Plane
# Step 4: Transform back for mapping
hospital_service_areas <- st_transform(hospital_service_areas, st_crs(pa_counties))
hospital_service_areas
ggplot() +
geom_sf(data = my_county, fill = "white", color = "gray") +
geom_sf(data = hospital_service_areas, fill = "lightblue", alpha = 0.4) +
geom_sf(data = my_county_hospitals, color = "red", size = 2) +
labs(
title = paste("Hospital Service Areas in", my_county$COUNTY_NAM[1], "County"),
subtitle = "Red points = Hospitals, Blue areas = 15-mile service zones"
) +
theme_void()
# Union all service areas into one polygon
combined_service_area <- hospital_service_areas %>%
st_union()
# Calculate areas (need to be in projected CRS)
my_county_proj <- st_transform(my_county, 3365)
combined_service_proj <- st_transform(combined_service_area, 3365)
# Find intersection
coverage_area <- st_intersection(my_county_proj, combined_service_proj)
# Calculate percentages
county_area <- as.numeric(st_area(my_county_proj))
covered_area <- as.numeric(st_area(coverage_area))
coverage_pct <- (covered_area / county_area) * 100
cat("County area:", round(county_area / 1e6, 1), "sq km\n")
cat("Covered area:", round(covered_area / 1e6, 1), "sq km\n")
cat("Coverage:", round(coverage_pct, 1), "%\n")
# Spatial join: districts to counties
districts_by_county <- districts %>%
st_join(pa_counties %>% select(COUNTY_NAM)) %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarize(
n_districts = n_distinct(OBJECTID),
district_ids = paste(unique(MSLINK), collapse = ", ")
) %>%
arrange(desc(n_districts))
View(districts)
View(pa_counties)
# Spatial join: districts to counties
districts_by_county <- districts %>%
st_join(pa_counties %>% select(COUNTY_NAM)) %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarize(
n_districts = n_distinct(OBJECTID),
district_ids = paste(unique(MSLINK), collapse = ", ")
) %>%
arrange(desc(n_districts))
# Step 1: Look at available county names
unique(pa_counties$COUNTY_NAM)
ggplot() +
geom_sf(data = my_county, fill = "green", color = "gray") +
geom_sf(data = hospital_service_areas, fill = "lightblue", alpha = 0.4) +
geom_sf(data = my_county_hospitals, color = "red", size = 2) +
labs(
title = paste("Hospital Service Areas in", my_county$COUNTY_NAM[1], "County"),
subtitle = "Red points = Hospitals, Blue areas = 15-mile service zones"
) +
theme_void()
ggplot() +
geom_sf(data = my_county, fill = "white", color = "gray") +
geom_sf(data = hospital_service_areas, fill = "lightblue", alpha = 0.4) +
geom_sf(data = my_county_hospitals, color = "red", size = 2) +
labs(
title = paste("Hospital Service Areas in", my_county$COUNTY_NAM[1], "County"),
subtitle = "Red points = Hospitals, Blue areas = 15-mile service zones"
) +
theme_void()
ggplot() +
geom_sf(data = my_county, fill = "grey", color = "gray") +
geom_sf(data = hospital_service_areas, fill = "lightblue", alpha = 0.4) +
geom_sf(data = my_county_hospitals, color = "red", size = 2) +
labs(
title = paste("Hospital Service Areas in", my_county$COUNTY_NAM[1], "County"),
subtitle = "Red points = Hospitals, Blue areas = 15-mile service zones"
) +
theme_void()
View(districts)
districts <- districts %>%
mutate(toupper(HOME_County))
districts <- districts %>%
mutate(toupper(HOME_COUNTY))
View(districts)
# Spatial join: districts to counties
districts_by_county <- districts %>%
st_join(pa_counties %>% select(COUNTY_NAM)) %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarize(
n_districts = n_distinct(OBJECTID),
district_ids = paste(unique(MSLINK), collapse = ", ")
) %>%
arrange(desc(n_districts))
districts <- districts %>%
HOME_COUNTY <- toupper(HOME_COUNTY)
st_crs(pa_counties)
st_crs(pa_counties)
st_crs(districts)
st_crs(pa_counties)
pa_counties <- st_transform(pa_counties, st_crs(districts))
# Spatial join: districts to counties
districts_by_county <- districts %>%
st_join(pa_counties %>% select(COUNTY_NAM)) %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarize(
n_districts = n_distinct(OBJECTID),
district_ids = paste(unique(MSLINK), collapse = ", ")
) %>%
arrange(desc(n_districts))
1e6
county_area
county_area / 1e6
my_neighbors_ov <- pa_counties %>%
st_filter(my_county, .predicate = st_overlaps)
my_neighbors_ov
my_neighbors_ov <- pa_counties %>%
st_filter(my_county, .predicate = st_overlaps)
# Spatial join: districts to counties
districts_by_county <- districts %>%
st_join(pa_counties %>% select(COUNTY_NAM)) %>%
st_drop_geometry() %>%
group_by(COUNTY_NAM) %>%
summarize(
n_districts = n_distinct(OBJECTID),
district_ids = paste(unique(MSLINK), collapse = ", ")
) %>%
arrange(desc(n_districts))
# Which counties have the most districts?
head(districts_by_county, 10)
st_crs(districts)
# Which counties have the most districts?
head(districts_by_county, 10)
# Get tract-level demographics
tract_demographics <- get_acs(
geography = "tract",
variables = c(
total_pop = "B01003_001",
median_income = "B19013_001",
white_pop = "B03002_003",
black_pop = "B03002_004",
hispanic_pop = "B03002_012"
),
state = "PA",
year = 2022,
output = "wide"
)
